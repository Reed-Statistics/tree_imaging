---
title: "Modelling"
author: "Sarah"
date: "2/10/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(raster)
library(caret)
library(tidyverse)
library(spdplyr)
library(doParallel)
library(pdxTrees)
library(sf)
library(tmap)
```

```{r}
# load masked raster images
stack_a <- stack("data/grass_mask_a.tif")
stack_b <- stack("data/grass_mask_b.tif")
stack_c <- stack("data/grass_mask_c.tif")
stack_d <- stack("data/grass_mask_d.tif")
stack_e <- stack("data/grass_mask_e.tif")

# load trained models
rf_model <- readRDS("data/rf_model.rds")
svm_model <- readRDS("data/svm_model.rds")
```


```{r}
# predictions on a raster object
stack_a <- stack(stack_a, ((stack_a[[4]] - stack_a[[1]])/(stack_a[[4]] + stack_a[[1]])),
                 (stack_a[[1]]/stack_a[[3]]), (stack_a[[4]]/stack_a[[1]]),
                 (stack_a[[1]]/stack_a[[2]]), (stack_a[[3]]/stack_a[[2]]))
names(stack_a) <- c("red", "green", "blue", "ir", "ndvi", "red_blue", 
                    "ir_red", "red_green", "blue_green")

# baby example prediction
small_stack <- crop(stack_a, extent(515000, 515100, 5050000, 5050100))
results <- raster::predict(small_stack, rf_model, progress = "text", 
                           factors = levels(small_stack))
raster::spplot(results)

# whole image prediction
cl <- makeCluster(3, type = "FORK")  
registerDoParallel(cl)  
start <- proc.time()
results <- raster::predict(stack_a, rf_model, progress = "text")
do_loop <- proc.time() - start
stopCluster(cl)
# about 10 min

raster::spplot(results)
```

```{r}
# prep rasters function
predRaster <- function(stack) {
  stack <- stack(stack, ((stack[[4]] - stack[[1]])/(stack[[4]] + stack[[1]])),
                 (stack[[1]]/stack[[3]]), (stack[[4]]/stack[[1]]),
                 (stack[[1]]/stack[[2]]), (stack[[3]]/stack[[2]]))
  names(stack) <- c("red", "green", "blue", "ir", "ndvi", "red_blue", 
                    "ir_red", "red_green", "blue_green")
  cl <- makeCluster(3, type = "FORK")  
  registerDoParallel(cl)  
  results_RF <- raster::predict(stack, rf_model, progress = "text")
  results_SVM <- raster::predict(stack, svm_model, progress = "text")
  results <- stack(results_RF, results_SVM)
  stopCluster(cl)
  return(results)
}

results_small <- predRaster(small_stack[[1:4]])
raster::spplot(results_small)

results_a <- predRaster(stack_a) # 41min
results_b <- predRaster(stack_b)
results_c <- predRaster(stack_c)
results_d <- predRaster(stack_d)
results_e <- predRaster(stack_e)

# save results
# writeRaster(results_a,"data/results_a.grd", format = "raster")
# writeRaster(results_b,"data/results_b.grd", format = "raster")
# writeRaster(results_c,"data/results_c.grd", format = "raster")
# writeRaster(results_d,"data/results_d.grd", format = "raster")
# writeRaster(results_e,"data/results_e.grd", format = "raster")
```

```{r}
# load results
results_a <- stack("data/results_a.grd")
results_b <- stack("data/results_b.grd")
results_c <- stack("data/results_c.grd")
results_d <- stack("data/results_d.grd")
results_e <- stack("data/results_e.grd")

rf_model[["levels"]]
names(results_a) <- c("results_RF", "results_SVM")

# load street trees western redcedars
pdxTrees_parks <- get_pdxTrees_parks()
pdxTrees_streets <- get_pdxTrees_streets()

redcedar_dat <- pdxTrees_streets %>%
  filter(Common_Name %in% "Western Redcedar")
coordinates(redcedar_dat) <- c("Longitude", "Latitude")
proj4string(redcedar_dat) <- CRS("+init=epsg:4326")
dat_transformed <- spTransform(redcedar_dat, CRS("+proj=utm +zone=10 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"))
spplot(spmap.to.lev(dat_transformed))


# plot results
proj_a <- projectRaster(results_a, crs = "+proj=utm +zone=10 +ellps=WGS84 +datum=WGS84 +units=m +no_defs", method = "ngb")
crs(results) <- "+proj=utm +zone=10 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"
r_pts <- rasterToPoints(proj_a, spatial=TRUE)
proj4string(r_pts)

# # reproject sp object
r_pts <- spTransform(r_pts, CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))
proj4string(r_pts)

ra_df <- as.data.frame(results_a, xy = T, na.rm = T) %>%
  filter(results_RF == 7)

ggplot(data.frame(dat_transformed), aes(Longitude, Latitude)) + 
  geom_point(shape = 3) +
  geom_point(data = ra_df, mapping = aes(x = x, y), color = "turquoise", alpha = 0.4) +
  theme_minimal()

spplot(proj_a)
spplot(redcedar_dat)

plot(redcedar_dat)
plot(results_a[[1]], add = T)

# if you have a list of Raster objects, you can use do.call
r_list_RF <- list(results_a[[1]], results_b[[1]])
r_list_SVM <- list(results_a[[2]], results_b[[2]])
m_RF <- do.call(merge, r_list_RF)
m_SVM <- do.call(merge, r_list_SVM)
plot(m_RF)
plot(m_SVM)
```

https://mgimond.github.io/Spatial/mapping-data-in-r.html
https://www.r-bloggers.com/2020/05/threading-and-caret-burning-your-cpu-to-improve-model-training-speed/
http://amsantac.co/blog/en/2015/11/28/classification-r.html
https://geoscripting-wur.github.io/AdvancedRasterAnalysis/