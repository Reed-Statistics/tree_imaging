---
title: "Modelling"
author: "Sarah"
date: "2/10/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(raster)
library(caret)
library(tidyverse)
library(spdplyr)
library(doParallel)
library(pdxTrees)
library(sf)
library(tigris)
```

```{r}
# load masked raster images
stack_a <- stack("data/grass_mask_a.tif")
stack_b <- stack("data/grass_mask_b.tif")
stack_c <- stack("data/grass_mask_c.tif")
stack_d <- stack("data/grass_mask_d.tif")
stack_e <- stack("data/grass_mask_e.tif")

# load trained models
rf_model <- readRDS("data/rf_model.rds")
svm_model <- readRDS("data/svm_model.rds")
```


```{r}
# predictions on a raster object
stack_a <- stack(stack_a, ((stack_a[[4]] - stack_a[[1]])/(stack_a[[4]] + stack_a[[1]])),
                 (stack_a[[1]]/stack_a[[3]]), (stack_a[[4]]/stack_a[[1]]),
                 (stack_a[[1]]/stack_a[[2]]), (stack_a[[3]]/stack_a[[2]]))
names(stack_a) <- c("red", "green", "blue", "ir", "ndvi", "red_blue", 
                    "ir_red", "red_green", "blue_green")

# baby example prediction
small_stack <- crop(stack_a, extent(515000, 515100, 5050000, 5050100))
results <- raster::predict(small_stack, rf_model, progress = "text", 
                           factors = levels(small_stack))
raster::spplot(results)

# whole image prediction
cl <- makeCluster(3, type = "FORK")  
registerDoParallel(cl)  
start <- proc.time()
results <- raster::predict(stack_a, rf_model, progress = "text")
do_loop <- proc.time() - start
stopCluster(cl)
# about 10 min

raster::spplot(results)
```

```{r}
# prep rasters function
predRaster <- function(stack) {
  stack <- stack(stack, ((stack[[4]] - stack[[1]])/(stack[[4]] + stack[[1]])),
                 (stack[[1]]/stack[[3]]), (stack[[4]]/stack[[1]]),
                 (stack[[1]]/stack[[2]]), (stack[[3]]/stack[[2]]))
  names(stack) <- c("red", "green", "blue", "ir", "ndvi", "red_blue", 
                    "ir_red", "red_green", "blue_green")
  cl <- makeCluster(3, type = "FORK")  
  registerDoParallel(cl)  
  results_RF <- raster::predict(stack, rf_model, progress = "text")
  results_SVM <- raster::predict(stack, svm_model, progress = "text")
  results <- stack(results_RF, results_SVM)
  stopCluster(cl)
  return(results)
}

results_small <- predRaster(small_stack[[1:4]])
raster::spplot(results_small)

results_a <- predRaster(stack_a) # 41min
results_b <- predRaster(stack_b)
results_c <- predRaster(stack_c)
results_d <- predRaster(stack_d)
results_e <- predRaster(stack_e)

# save results
# writeRaster(results_a,"data/results_a.grd", format = "raster", overwrite = T)
# writeRaster(results_b,"data/results_b.grd", format = "raster", overwrite = T)
# writeRaster(results_c,"data/results_c.grd", format = "raster", overwrite = T)
# writeRaster(results_d,"data/results_d.grd", format = "raster", overwrite = T)
# writeRaster(results_e,"data/results_e.grd", format = "raster", overwrite = T)
```

Visualize results
```{r}
# load results
results_a <- stack("data/results_a.grd")
results_b <- stack("data/results_b.grd")
results_c <- stack("data/results_c.grd")
results_d <- stack("data/results_d.grd")
results_e <- stack("data/results_e.grd")

# merge rasters into one for plotting
r_list_RF <- list(results_a[[1]] == 7, results_b[[1]] == 7, results_c[[1]] == 7,
                  results_d[[1]] == 7, results_e[[1]] == 7)
r_list_SVM <- list(results_a[[2]] == 7, results_b[[2]] == 7, results_c[[2]] == 7,
                  results_d[[2]] == 7, results_e[[2]] == 7)
m_RF <- do.call(merge, r_list_RF)
m_SVM <- do.call(merge, r_list_SVM)

# compare rasters
r_matches <- m_RF == m_SVM
freq(r_matches)
freq(r_matches)[2, ]/(freq(r_matches)[2, ] + freq(r_matches)[1, ])
# (r_matches == 1)/((r_matches == 0) + (r_matches == 1)) percentage in common: 85%
plot(r_matches == 1, main = "RF and SVM Predictions Comparisons",
     labels = F, xaxt = 'n', yaxt = 'n', legend = F, col = "lightgreen")
plot(r_matches == 0, col = "maroon", labels = F, xaxt = 'n', yaxt = 'n',
     legend = F, add = T)

# load city outline
or_cities <- places("OR")
portland <- or_cities %>%
  filter(NAME == "Portland")
portland_wgs84 <- spTransform(portland, 
                              CRS("+proj=utm +zone=10 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"))

# plot predictions
plot(m_RF, main = "RF Western Redcedar Predictions", 
     labels = F, xaxt = 'n', yaxt = 'n', legend = F, col = "darkgreen")
plot(portland_wgs84, add = T)

plot(m_SVM, main = "SVM Western Redcedar Predictions", 
     labels = F, xaxt = 'n', yaxt = 'n', legend = F, col = "darkgreen")
plot(portland_wgs84, add = T)
```

Compare to pdxTrees
```{r}
# load street trees western redcedars
pdxTrees_parks <- get_pdxTrees_parks()
pdxTrees_streets <- get_pdxTrees_streets()

redcedar_dat_street <- pdxTrees_streets %>%
  filter(Common_Name %in% "Western Redcedar") %>%
  dplyr::select(Longitude, Latitude, Common_Name)
redcedar_dat_park <- pdxTrees_parks %>%
  filter(Common_Name %in% "Western Redcedar") %>%
  dplyr::select(Longitude, Latitude, Common_Name)
redcedar_dat <- rbind(redcedar_dat_street, redcedar_dat_park)

# match coordinate reference system
coordinates(redcedar_dat) <- c("Longitude", "Latitude")
proj4string(redcedar_dat) <- CRS("+init=epsg:4326")
dat_transformed <- spTransform(redcedar_dat, CRS("+proj=utm +zone=10 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"))


# plot pdxTrees with predictions
plot(m_RF, main = "RF Predictions with pdxTrees", 
     labels = F, xaxt = 'n', yaxt = 'n', legend = F, col = "darkgreen")
plot(dat_transformed, col = rgb(red = 0.2, green = 0.2, blue = 1.0, alpha = 0.2), cex = .2, add = T)
plot(portland_wgs84, add = T)

plot(m_SVM, main = "SVM Predictions with pdxTrees", 
     labels = F, xaxt = 'n', yaxt = 'n', legend = F, col = "darkgreen")
plot(dat_transformed, col = rgb(red = 0.2, green = 0.2, blue = 1.0, alpha = 0.2), cex = .2, add = T)
plot(portland_wgs84, add = T)

# match pixels with pdxTrees to test for accuracy
street_mask <- mask(m_RF, dat_transformed)
freq(street_mask)[1, 2]/nrow(dat_transformed) # testing accuracy estimates for Western redcedars
# 65%
```

https://mgimond.github.io/Spatial/mapping-data-in-r.html
https://www.r-bloggers.com/2020/05/threading-and-caret-burning-your-cpu-to-improve-model-training-speed/
http://amsantac.co/blog/en/2015/11/28/classification-r.html
https://geoscripting-wur.github.io/AdvancedRasterAnalysis/