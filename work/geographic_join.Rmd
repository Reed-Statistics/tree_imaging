---
title: "Geographic Join"
author: "Sarah"
date: "10/18/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(raster)
library(sp)
library(sf)
library(rgdal)
library(hsdar)
```

```{r}
# load polygon shapefiles
acpl <- st_read("/Users/sarahkmaebius/Documents/Fall_2020_Reed/Thesis/tree_canopy/acpl_polygon.shp")
psme <- st_read("/Users/sarahkmaebius/Documents/Fall_2020_Reed/Thesis/tree_canopy/psme_polygon.shp")
quru <- st_read("/Users/sarahkmaebius/Documents/Fall_2020_Reed/Thesis/tree_canopy/quru_polygon.shp")
redcedar <- st_read("/Users/sarahkmaebius/Documents/Fall_2020_Reed/Thesis/tree_canopy/redwood_polygon.shp")
segi <- st_read("/Users/sarahkmaebius/Documents/Fall_2020_Reed/Thesis/tree_canopy/segi_polygon.shp")

# add polygon tree type column
acpl$id_type <- "acpl"
psme$id_type <- "psme"
quru$id_type <- "quru"
redcedar$id_type <- "redcedar"
segi$id_type <- "segi"

# combine polygon shapefiles
combined_poly <- rbind(acpl, psme, quru, redcedar, segi)

# create multipolygon object
multi_poly <- st_multipolygon(combined_poly$geometry)

# load point datasets
acpl_pts <- st_read("/Users/sarahkmaebius/Documents/Fall_2020_Reed/Thesis/tree_imaging/shapefiles/acpl_shapefile.shp")
psme_pts <- st_read("/Users/sarahkmaebius/Documents/Fall_2020_Reed/Thesis/tree_imaging/shapefiles/psme_shapefile.shp")
quru_pts <- st_read("/Users/sarahkmaebius/Documents/Fall_2020_Reed/Thesis/tree_imaging/shapefiles/quru_shapefile.shp")
redcedar_pts <- st_read("/Users/sarahkmaebius/Documents/Fall_2020_Reed/Thesis/tree_imaging/shapefiles/redcedar_shapefile.shp")
segi_pts <- st_read("/Users/sarahkmaebius/Documents/Fall_2020_Reed/Thesis/tree_imaging/shapefiles/segi_shapefile.shp")

# combine point datasets
combined_pts <- rbind(acpl_pts, psme_pts, quru_pts, redcedar_pts, segi_pts)

# join combined points to combined polygons
poly_join <- st_join(combined_poly, combined_pts, largest = T)

# tidy polygon-point dataset
poly_join <- poly_join %>%
  mutate(id = c(1:510))
```

```{r}
# load raster layer object
raster_pdx_stack <- stack("planet/20200902_184428_1005_3B_AnalyticMS_clip.tif")

# match raster project to polygons
raster_crs <- CRS(projection(raster_pdx_stack))
poly_join_reprojected <- spTransform(as_Spatial(poly_join), raster_crs)

# extract pixel values from polygons into a dataframe
raster_val <- raster::extract(raster_pdx_stack, poly_join_reprojected, df = TRUE)
```

```{r}
# tidy pixel table
pixels_data <- sp::merge(raster_val, poly_join_reprojected, by.x = "ID", by.y = "id")

pixels_data <- pixels_data %>%
  rename("blue" = "X20200902_184428_1005_3B_AnalyticMS_clip.1",
         "green" = "X20200902_184428_1005_3B_AnalyticMS_clip.2",
         "red" = "X20200902_184428_1005_3B_AnalyticMS_clip.3",
         "ir" = "X20200902_184428_1005_3B_AnalyticMS_clip.4")
```

```{r}
# initial analysis
pixels_data %>%
  drop_na(blue, green, red, ir) %>%
  group_by(Cmmn_Nm) %>%
  summarise(counts = n())

pix_no_na <- pixels_data %>%
  drop_na(blue, green, red, ir)

n_distinct(pix_no_na)
```

```{r}
ndvi <- (raster_pdx_stack[[4]] - raster_pdx_stack[[1]]) / (raster_pdx_stack[[4]] + raster_pdx_stack[[1]])

plot(ndvi, main = "NDVI of North Portland", axes = FALSE, box = FALSE)

av_nir <- mean(raster_pdx_stack[[4]])
av_green <- mean(raster_pdx_stack[[3]])
av_blue <- mean(raster_pdx_stack[[2]])
av_red <- mean(raster_pdx_stack[[1]])
```

NDVI formula:
$$NDVI = \frac{NIR - Red}{NIR + Red}$$
References: 
https://geocompr.robinlovelace.net/spatial-operations.html#spatial-ras
https://www.earthdatascience.org/courses/earth-analytics/multispectral-remote-sensing-data/vegetation-indices-NDVI-in-R/
